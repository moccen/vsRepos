function initialWelcomePage(){var window_width=$(window).width();var window_height=$(window).height();$(".modal_window").each(function(){var modal_height=$(this).outerHeight();var modal_width=$(this).outerWidth();var top=(window_height-modal_height)/2;var left=(window_width-modal_width)/2;$(this).css({"top":top,"left":left})});show_modal("modal_window");$(".close_modal").click(function(){close_modal()});$(".modal_window").click(function(event){close_modal()})}function close_modal(){$("#mask").fadeOut(500);$(".modal_window").fadeOut(500)}function show_modal(modal_id){$("#mask").css({"display":"block",opacity:0});$("#mask").fadeTo(500,0.8);$("#"+modal_id).fadeIn(500)};
var supports=(function(){var style=document.createElement("div").style,vendors=["","Moz","Webkit","Khtml","O","ms"],prefix,i,l;return function(prop){if(typeof style[prop]==="string"){return true}prop=prop.replace(/^[a-z]/,function(val){return val.toUpperCase()});for(i=0,l=vendors.length;i<l;i+=1){prefix=vendors[i]+prop;if(typeof style[prefix]==="string"){return true}}return false}})();var slider=(function($){var module={npos:0,timer:null,config:function(config){module.target=config.target;module.container=module.target.find(".slider-wrapper");module.sWidth=module.container.find(".slide").outerWidth(true);module.max=module.container.find(".slide").length;module.tWidth=module.sWidth*module.max;module.time=config.time||5000},early:function(){var self=this,slider=self.target,i,l;self.container.css({width:self.tWidth});slider.append(self.pager());for(i=0,l=self.max;i<l;i+=1){self.items(i+1).insertBefore($(".slider-nav .next").parents("li"))}slider.find(".bullet:first").addClass("active")},events:function(){var self=this,slider=self.target;slider.on("click",".slider-nav a",function(e){e.preventDefault();var $this=$(this),index=$this.html();if($this.hasClass("next")){self.next()}if($this.hasClass("prev")){self.prev()}if($this.hasClass("bullet")){self.bullets(index);self.update()}});self.container.on({mouseenter:function(){clearTimeout(self.timer)},mouseleave:function(){module.auto()}})},slip:function(){if(supports("transition")){module.container.css({left:-module.npos*module.sWidth})}else{module.container.animate({left:-module.npos*module.sWidth},800)}},bullets:function(index){clearTimeout(module.timer);module.auto();module.npos=parseInt(index,null)-1;module.slip()},prev:function(){clearTimeout(module.timer);module.auto();module.npos-=1;if(module.npos<0){module.npos=module.max-1}module.slip();module.update()},next:function(){clearTimeout(module.timer);module.auto();module.npos+=1;if(module.npos>(module.max-1)){module.npos=0}module.slip();module.update()},update:function(){var self=this,slider=self.target;
slider.find(".bullet").removeClass("active");slider.find(".bullet").eq(self.npos).addClass("active")},auto:function(){var self=this;self.timer=setTimeout(self.next,self.time)},pager:function(){var nav=$('<ul class="slider-nav"><li><a href="#" class="control prev">Prev</a></li><li><a href="#" class="control next">Next</a></li></ul>');return nav},items:function(i){var item=$('<li><a class="bullet" href="#">'+i+"</a></li>");return item},init:function(config){module.config(config);if(!module.max||module.max===1){return}module.auto();module.events();module.early()},clearAll:function(){var self=module;if(self.timer){clearTimeout(self.timer)}if(self.container){self.container.off();self.container.removeAttr("style")}if(self.target){self.target.off()}}};return{init:module.init,clear:module.clearAll}}(jQuery));var albumMgr=(function(){var module={init:function(e){var stadiumId=e.getAttribute("data-para");if(stadiumId=="undefined"){windows.alert("can not get stadium ID!");return}$("#albumMask").fadeIn(500);$("#loadingAlbum").css({"display":"block"});myapp.activeDataWorkspace.ApplicationData.StadiumQueryByIds(stadiumId).expand("StadiumPhotoCollection").execute().then(function(stadiumItem){var rslt=stadiumItem.results[0];if(rslt&&rslt.StadiumPhotoCollection&&rslt.StadiumPhotoCollection.array.length>0){$("#loadingAlbum").hide();module.showpic(stadiumItem.results[0].StadiumPhotoCollection.array)}else{$("#albumMask").css({"display":"none"});$("#loadingAlbum").css({"display":"none"});notifier.showNotice({msg:"<b>当前场馆没有图片！</b>",type:"warning",position:"center",opacity:0.9})}})},showpic:function(imgdata){if(!imgdata){return}var pichtml="";for(var i in imgdata){if(imgdata.hasOwnProperty(i)){if(i.Photo){pichtml+="<img src='data:image/svg;base64,"+i.Photo+"' class = 'slide'/>"}else{pichtml+="<img src='data:image/svg;base64,"+imgdata[i].Photo+"' class = 'slide'/>"}}}$("#picWrapper").html(pichtml);slider.init({target:$(".slider"),time:6000})},close:function(){$("#albumMask").fadeOut(500);slider.clear();
$("#picWrapper img").remove();$(".slider-nav").remove()}};return{init:module.init,show:module.showpic,close:module.close}})();
var JqGridGrouper=(function($){var moduleFactory={createModule:function(conf){var module={};module.conf=conf;module.config=function(conf){module.groupdata=conf.groupdata;module.pNode=conf.pNode};module.exceptionary=[];module.init=function(){module.config(module.conf);if(!module.groupdata||!module.pNode||module.groupdata.length===0){return}module.resultStock=module.pNode.find(".resultStock");var grouphtml='<div class="content"><div data-widget="tabs" class="m tabs-stock">'+'<div class="mt">'+'    <ul class="tab">'+'        <li data-index="0" data-widget="tab-item" class="curr"><a href="#1" class="hover"><em>请选择</em></a></li>'+"    </ul>"+'    <div class="stock-line"></div>'+"</div>"+'<div class="mc curr" data-area="0" data-widget="tab-content"></div>'+"</div></div>";var resultStockTxt=module.resultStock.find(".text");resultStockTxt.after(grouphtml);resultStockTxt.unbind("click").bind("click",function(){module.resultStock.addClass("hover");module.resultStock.find(".content").show()});var firstPanel=module.pNode.find(".mc.curr");firstPanel.html(module.getgrouplist(module.groupdata));firstPanel.find("ul li").click(function(e){module.onItemsClick(this)});module.pNode.find(".m.tabs-stock .mt .tab li").click(function(e){module.onTabClick(this)})};module.getgrouplist=function(result){var html=["<ul class='groupBy-list'>"];var longhtml=[];var longerhtml=[];if(result&&result.length>0){for(var i=0,j=result.length;i<j;i++){if(module.exceptionary.indexOf(result[i].id)!=-1){continue}result[i].name=result[i].name.replace(" ","");if(result[i].name.length>12){longerhtml.push("<li class='longer-area'><a href='#1' data-value='"+result[i].id+"'>"+result[i].name+"</a></li>")}else{if(result[i].name.length>5){longhtml.push("<li class='long-area'><a href='#1' data-value='"+result[i].id+"'>"+result[i].name+"</a></li>")}else{html.push("<li><a href='#1' data-value='"+result[i].id+"'>"+result[i].name+"</a></li>")}}}}html.push(longhtml.join(""));html.push(longerhtml.join(""));html.push("</ul>");
return html.join("")};module.onItemsClick=function(clickitem){var tabs=module.pNode.find("ul.tab > li");var that=clickitem;var tabindex=parseInt($(that).parent().parent().hide().attr("data-area"));var nexttabindex=tabindex+1;var curtab=module.pNode.find(".tab li[data-index ="+tabindex+"]");if(tabs.length>2){curtab.removeClass("curr").find("em").html($(that).text());module.changeSummaryText();return}var nexttab=module.pNode.find(".tab li[data-index = "+nexttabindex+"]");module.exceptionary.push(parseInt($(that).find("a").attr("data-value")));if(nexttab.length>0){nexttab.addClass("curr").show()}else{var newtabhtml='<li data-index="'+nexttabindex+'" data-widget="tab-item" class="curr"><a href="#1" class="hover"><em>请选择</em><i></i></a></li>';var newitemshtml='<div class="mc curr" data-area="'+nexttabindex+'" data-widget="tab-content"></div>';curtab.removeClass("curr").after(newtabhtml);module.pNode.find(".tab li[data-index = "+nexttabindex+"]").click(function(e){module.onTabClick(this)});$(that).parent().parent().removeClass("curr").after(newitemshtml);module.pNode.find(".curr").show()}module.pNode.find(".mc[data-area="+nexttabindex+"]").html(module.getgrouplist(module.groupdata)).show();module.pNode.find(".mc[data-area = "+nexttabindex+"] ul li").click(function(e){module.onItemsClick(this)});curtab.removeClass("curr").find("em").html($(that).text());module.changeSummaryText()};module.onTabClick=function(tabitem){if($(tabitem).attr("class")!="curr"){$(tabitem).addClass("curr");$(tabitem).find("em").html("请选择");var nextall=$(tabitem).nextAll();for(var i=0,len=nextall.length;i<len;i++){module.exceptionary.pop()}nextall.remove();var curitemnode=module.pNode.find(".mc[data-area="+$(tabitem).attr("data-index")+"]");curitemnode.nextAll().remove();curitemnode.addClass("curr").show();module.changeSummaryText()}};module.changeSummaryText=function(){var tabs=module.pNode.find(".tab em");var tabstrs=$(tabs[0]).text();for(var i=1,len=tabs.length;i<len;i++){if($(tabs[i]).text()=="请选择"){continue
}tabstrs+=">"+$(tabs[i]).text()}module.resultStock.find(".text div").html(tabstrs)};return module},createGroupModule:function(conf){var groupModule={};groupModule.conf=conf;groupModule.formerGroupStr=null;groupModule.config=function(conf){groupModule.groupCols=conf.groupCols;groupModule.pNode=conf.pNode;groupModule.jqGridId=conf.jqGridId};groupModule.getGroupData=function(){var groupItems=[];for(var i=0;i<groupModule.groupCols.length;i++){var temp={};temp.id=i;temp.name=groupModule.groupCols[i];groupItems.push(temp)}return groupItems};groupModule.init=function(){groupModule.config(groupModule.conf);if(!groupModule.pNode||!groupModule.jqGridId){return}var groupItems=groupModule.getGroupData();groupModule.pNode.addClass("groupSelector");groupModule.pNode.append("<div style='margin:5px auto 10px auto;'><div><div class='dt'>分组依据：</div><div class='dd'><div class = 'resultStock'><div class='text'><div>请选择</div></div><div class='close'></div></div></div></div></div>");groupModule.pNode.find(".close").click(function(e){groupModule.pNode.find(".resultStock").removeClass("hover");e.stopPropagation();groupModule.setGroup()});var module=moduleFactory.createModule({"groupdata":groupItems,"pNode":groupModule.pNode});module.init()};groupModule.setGroup=function(){var groupStr=groupModule.pNode.find(".resultStock .text div").text();if(groupModule.formerGroupStr===groupStr){return}if(groupStr==="请选择"){$(groupModule.jqGridId).jqGrid("groupingRemove",true);return}var groupFields=groupStr.split(">");$(groupModule.jqGridId).jqGrid("groupingGroupBy",groupFields);groupModule.formerGroupStr=groupStr};return groupModule}};return{createNew:function(conf){var groupMgr={};var groupModule=moduleFactory.createGroupModule(conf);groupMgr.init=function(){groupModule.init()};return groupMgr}}})(jQuery);
(function(name,context,factory){context[name]=factory()})("mainManager",this,function(){window.__pivotHash__={};var streetDict={},cateDict={};var util={eachAry:function(ary,func){for(var i=0,len=ary.length;i<len;i++){func(ary[i])}},eachProp:function(obj,func){var prop;for(prop in obj){if(obj.hasOwnProperty(prop)){if(util.hasProp(obj,prop)){func(obj[prop])}}}},hasProp:function(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)},resizeLayout:function(){var width=$(window).width()-30;var height=$(window).height()*0.88;$("#layout").layout("resize",{width:width,height:height})},buildTree:function(array){try{var roots=[],children={};for(var i=0,len=array.length;i<len;++i){var item=array[i],p=item.Parent;var node={id:item.Id,text:item.Name},target=!p?roots:(children[p.Id]||(children[p.Id]=[]));target.push(node)}var findChildren=function(parent){if(children[parent.id]){parent.children=children[parent.id];for(var i=0,len=parent.children.length;i<len;++i){findChildren(parent.children[i])}}};for(var i=0,len=roots.length;i<len;++i){findChildren(roots[i])}return roots}catch(e){console.log(e)}},getCheckedTreeNode:function(treeId,nodeType){try{if(treeId){nodeType=nodeType||"id";var nodes=$(treeId).tree("getChecked");var s="";for(var i=0;i<nodes.length;i++){if(nodes[i].checked){if(s!=""){s+=","}s+=nodes[i][nodeType]}}return s}}catch(e){console.log(e.message)}},resizJqGrid:function(){try{var width=$("#regioncenter").width()-12;$("#stadiumInfo").setGridWidth(width,true);$("#ecoStatusInfo").setGridWidth(width,true)}catch(e){console.log(e)}},resizePiovt:function(){try{var width=$("#regioncenter").width()-150;$("#stadiumPivot").width(width);$("#ecoPivot").width(width)}catch(e){console.log(e)}},onRegionCentrChange:function(){var resizer=document.getElementById("regioncenter");window.addResizeListener(resizer,util.resizJqGrid)},upDatePivot:function(pivotName,pData){try{if(window.__pivotHash__[pivotName]){$(pivotName).pivotUI(pData)}else{if(pData.length>0){window.__pivotHash__[pivotName]=$(pivotName).pivotUI(pData,{renderers:$.pivotUtilities.locales.zh.renderers},true,"zh");
$(window).bind("resize",function(){$(pivotName).width(($("#regioncenter").width()*0.9))})}}}catch(e){console.log(e.message)}},getPermissionAry:function(permissionStr){return permissionStr.split(",")},getStreeTreeDict:function(treeId,treeData){if(treeId==="#streetTree"){var treeDict={};for(var i=0,len=treeData.length;i<len;i++){var treeItem=treeData[i];treeDict[treeItem.id]=treeItem.text}streetDict=treeDict}}};(function(){var attachEvent=document.attachEvent;var isIE=navigator.userAgent.match(/Trident/);var requestFrame=(function(){var raf=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(fn){return window.setTimeout(fn,20)};return function(fn){return raf(fn)}})();var cancelFrame=(function(){var cancel=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.clearTimeout;return function(id){return cancel(id)}})();function resizeListener(e){var win=e.target||e.srcElement;if(win.__resizeRAF__){cancelFrame(win.__resizeRAF__)}win.__resizeRAF__=requestFrame(function(){var trigger=win.__resizeTrigger__;trigger.__resizeListeners__.forEach(function(fn){fn.call(trigger,e)})})}function objectLoad(e){this.contentDocument.defaultView.__resizeTrigger__=this.__resizeElement__;this.contentDocument.defaultView.addEventListener("resize",resizeListener)}window.addResizeListener=function(element,fn){if(!element.__resizeListeners__){element.__resizeListeners__=[];if(attachEvent){element.__resizeTrigger__=element;element.attachEvent("onresize",resizeListener)}else{if(getComputedStyle(element).position=="static"){element.style.position="relative"}var obj=element.__resizeTrigger__=document.createElement("object");obj.setAttribute("style","display: block; position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden; pointer-events: none; z-index: -1;");obj.__resizeElement__=element;obj.onload=objectLoad;obj.type="text/html";if(isIE){element.appendChild(obj)}obj.data="about:blank";
if(!isIE){element.appendChild(obj)}}}element.__resizeListeners__.push(fn)};window.removeResizeListener=function(element,fn){element.__resizeListeners__.splice(element.__resizeListeners__.indexOf(fn),1);if(!element.__resizeListeners__.length){if(attachEvent){element.detachEvent("onresize",resizeListener)}else{element.__resizeTrigger__.contentDocument.defaultView.removeEventListener("resize",resizeListener);element.__resizeTrigger__=!element.removeChild(element.__resizeTrigger__)}}}})();var permissionChecker={getIntersect:function(a,b){var t;if(b.length>a.length){t=b,b=a,a=t}return a.filter(function(e){if(b.indexOf(e)!==-1){return true}return false})},getSpecElPermission:function(elId){if(!elId){return undefined}var permissions=this.getPermissionDic();return permissions[elId]},getPermissionDic:function(){var elPermission={};elPermission["stadiumPivot"]=["CanVisitStastics"];elPermission["ecoPivot"]=["CanVisitStastics"];return elPermission},hasPermission:function(userPermissions,elId){var elPermissions=this.getSpecElPermission(elId);if(!elPermissions){return true}if(!userPermissions||userPermissions["length"]<1){return false}var intersect=this.getIntersect(userPermissions,elPermissions);if(intersect.length>0){return true}return false}};var eleId=1;var uiBuilder=(function(){var builder={};function getTreeConf(elId){return{"id":elId,"style":"padding:5px","class":"easyui-tree","data-options":"animate:true,checkbox:true",elType:"ul"}}function getPanelConf(configObj){var panelConf={};var children={};panelConf["parent"]={"id":configObj.parent.Id,"title":configObj.parent.title,style:"padding:10px",elType:"div"};children[configObj.children.Id]=getTreeConf(configObj.children.Id);panelConf["children"]=children;return panelConf}function getAccordConf(permissions){var accordionConfig={};var children={};accordionConfig["parent"]={id:"accordionID","class":"easyui-accordion","data-options":"fit:true,border:true,multiple:false",elType:"accordion"};accordionConfig["children"]=children;if(permissionChecker.hasPermission(permissions,"streetPanel")){children["streetPanel"]=getPanelConf({"parent":{"Id":"streetPanel","title":"所属街道"},"children":{"Id":"streetTree"}})
}if(permissionChecker.hasPermission(permissions,"catePanel")){children["catePanel"]=getPanelConf({parent:{Id:"catePanel",title:"场地代码"},children:{Id:"cateTree"}})}if(permissionChecker.hasPermission(permissions,"placePanel")){children["placePanel"]=getPanelConf({"parent":{"Id":"placePanel","title":"场地分布"},"children":{"Id":"placeTree"}})}if(permissionChecker.hasPermission(permissions,"ownerPanel")){children["ownerPanel"]=getPanelConf({"parent":{"Id":"ownerPanel","title":"场地归属"},"children":{"Id":"ownerTree"}})}if(permissionChecker.hasPermission(permissions,"openingPanel")){children["openingPanel"]=getPanelConf({"parent":{"Id":"openingPanel","title":"对外开放情况"},"children":{"Id":"openingTree"}})}if(permissionChecker.hasPermission(permissions,"recievePanel")){children["recivePanel"]=getPanelConf({"parent":{"Id":"recievePanel","title":"平均每周接待人次"},"children":{"Id":"recieveTree"}})}if(permissionChecker.hasPermission(permissions,"operModePanel")){children["operModePanel"]=getPanelConf({"parent":{"Id":"operModePanel","title":"运营模式"},"children":{"Id":"operModeTree"}})}return accordionConfig}function getMenuConf(permissions){var menuConf={};var children={};menuConf["parent"]={style:"padding:5px;background-color:menu",elType:"div"};menuConf["children"]=children;children["search"]={id:"lbSeachID",showText:"查询",iconCls:"icon-search",elType:"button"};children["expandID"]={id:"expandID",showText:"展开",iconCls:"icon-add",elType:"button"};children["collapseID"]={id:"collapseID",showText:"折叠",iconCls:"icon-remove",elType:"button"};return menuConf}function getRegionConf(regionPos,regionTitle,regionWidth){var regionConfig={"id":"region"+regionPos,"title":regionTitle,"data-role":"none","data-options":"region:'"+regionPos+"',split:true"};if(regionPos!=="center"){regionConfig.width=regionWidth||$(window).width()*0.2}return regionConfig}function getRegionsConfig(permissions){var regionConfig={};if(permissionChecker.hasPermission(permissions,"regionwest")){var accordConf=getAccordConf(permissions);
var menuConf=getMenuConf(permissions);regionConfig["regionWest"]={};regionConfig["regionWest"]["parent"]=getRegionConf("west","查询面板");regionConfig["regionWest"]["children"]={menuConf:menuConf,accordConf:accordConf}}function getTabsConf(permissions){var tabsConfigs={};var children={};var getMapConf=function(){var mapIdConfig={};var child={};mapIdConfig["parent"]={id:"mapTab",title:"地图",style:"padding:10px",elType:"div"};mapIdConfig["children"]=child;child["mapID"]={id:"mapID",style:"width:100%; height:100%;",elType:"div"};return mapIdConfig};var getStadiumInfo=function(){var tabConfig={};var child={};tabConfig["parent"]={id:"stadiumTab",title:"场馆信息",style:"padding:5px",elType:"tabs"};tabConfig["children"]=child;child["groupBy-ul"]={id:"groupBySelector",elType:"div"};child["stadiumInfo"]={id:"stadiumInfo",elType:"table"};child["stadiumPager"]={id:"stadiumPager",elType:"div"};return tabConfig};var getEcoInfo=function(){var tabConfig={};var child={};tabConfig["parent"]={id:"ecoStatusTab",title:"运营情况",style:"padding:5px",elType:"tabs"};tabConfig["children"]=child;child["groupByEco"]={id:"EcoGroupByer",elType:"div"};child["jqGridTable"]={id:"ecoStatusInfo",elType:"table"};child["jqPager"]={id:"ecoStatusPager",elType:"div"};return tabConfig};var getPivotConf=function(configs){var pivotConf={};var child={};var parentId=configs.pivotId+"tab";pivotConf["parent"]={id:parentId,title:configs.tabTitle,style:"padding:10px","class":"pivottable-master",elType:"div"};pivotConf["children"]=child;child[configs.pivotId]={id:configs.pivotId,style:"margin: 10px;width: 100%",elType:"div"};return pivotConf};tabsConfigs["parent"]={"class":"easyui-tabs","data-options":"fit:true,border:false,plain:true",elType:"tabs"};tabsConfigs["children"]=children;if(permissionChecker.hasPermission(permissions,"mapID")){children["mapID"]=getMapConf()}if(permissionChecker.hasPermission(permissions,"stadiumInfo")){children["stadiumInfo"]=getStadiumInfo()}if(permissionChecker.hasPermission(permissions,"ecoStatusInfo")){children["ecoStatusInfo"]=getEcoInfo()
}if(permissionChecker.hasPermission(permissions,"stadiumPivot")){children["stadiumPivot"]=getPivotConf({tabTitle:"场馆信息统计",pivotId:"stadiumPivot"})}if(permissionChecker.hasPermission(permissions,"ecoPivot")){children["ecoPivot"]=getPivotConf({tabTitle:"运营情况统计",pivotId:"ecoPivot"})}return tabsConfigs}regionConfig["regionCenter"]={"parent":getRegionConf("center","内容面板"),"children":getTabsConf(permissions)};return regionConfig}function getChildrenConf(childrenConfs){var children={};util.eachProp(childrenConfs,function(confVal){if(confVal.id){children[confVal.id]=confVal}else{if(confVal["parent"]&&confVal["parent"].id){children[confVal.parent.id]=confVal}else{children[confVal.elType+eleId++]=confVal}}});return children}function getLayoutConf(){var layoutConf={};layoutConf["parent"]={"id":"layout","class":"easyui-layout","data-role":"none","elType":"div"};var regionsConf=getRegionsConfig(arguments[0]);layoutConf["children"]=getChildrenConf(regionsConf);return layoutConf}function elFactory(elConfig,elType){var tagType=elType;if(elConfig.elType){delete elConfig.elType}if(tagType){switch(tagType.toLowerCase()){case"layout":case"region":case"accordion":case"menu":case"panel":case"tabs":case"tabpage":return $("<div></div>",elConfig);break;case"button":return createBtnEasy(elConfig);break;case"tree":return createElement("ul",elConfig);break;default:return createElement(elType,elConfig)}}else{return $("<div></div>",elConfig)}}function createElement(eleType,eleConfig){switch(eleType){case"a":if(eleConfig){return $("<a></a>",eleConfig)}else{return $("<a></a>")}break;case"ul":if(eleConfig){return $("<ul></ul>",eleConfig)}else{return $("<ul></ul>")}break;case"input":if(eleConfig){return $("<input></input>",eleConfig)}else{return $("<input></input>")}break;case"table":if(eleConfig){return $("<table></table>",eleConfig)}else{return $("<table></table>")}break;case"span":if(eleConfig){return $("<span></span>",eleConfig)}else{return $("<span></span>")}break;default:if(eleConfig){return $("<div></div>",eleConfig)
}else{return $("<div></div>")}break}}function createBtnEasy(btnConfig){var btn=$("<a></a>",{id:btnConfig.id});btn.linkbutton({iconCls:btnConfig.iconCls,text:btnConfig.showText,plain:true});return btn}function createTreeEle(configs){var parent=arguments[1];if(configs["parent"]){var subParent=elFactory(configs.parent,configs.parent.elType);if(parent){parent.append(subParent)}else{parent=subParent}util.eachProp(configs.children,function(conf){if(conf["parent"]){var son=elFactory(conf.parent,conf.parent.elType);subParent.append(son);createTreeEle(conf.children,son)}else{var child=elFactory(conf,conf.elType);subParent.append(child)}})}else{util.eachProp(configs,function(conf){if(conf["parent"]){createTreeEle(conf,parent)}else{var child=elFactory(conf,conf.elType);parent.append(child)}})}return parent}builder.buildLayout=function(){var permissions=arguments[0];var layoutConf=getLayoutConf(permissions);var layout=createTreeEle(layoutConf);return layout};return builder})();var dataManager={loadTree:function(treeId,dataSet){var treeData=[];var appData=myapp.activeDataWorkspace.ApplicationData;if(appData[dataSet]){appData[dataSet].load().then(function(promiseItem){var results=promiseItem.results;for(var i=0,len=results.length;i<len;i++){var val={};val["id"]=results[i].Id;val["text"]=results[i].Name;treeData[i]=val}$(treeId).tree({data:treeData});util.getStreeTreeDict(treeId,treeData)})}},loadCateTree:function(treeId){var cateTree=[];myapp.activeDataWorkspace.ApplicationData.CategorySet.expand("Parent").execute().then(function(promiseItem){cateTree=util.buildTree(promiseItem.results);$(treeId).tree({data:cateTree})})},loadStaticTree:function(treeId,treeData){$(treeId).tree({data:treeData})},getPlaceTreeData:function(){var dataSet=[{text:"广场"},{text:"公园"},{text:"校园"},{text:"工矿"},{text:"机关企事业单位楼院"},{text:"宾馆商场饭店"},{text:"居住小区/街道"},{text:"乡镇/村"},{text:"军营"},{text:"其他"}];return dataSet},getOpenTreeData:function(){var dataSet=[{text:"不开放"},{text:"部分时段开放"},{text:"全天开放"}];return dataSet
},getRecvTreeData:function(){var dataSet=[{text:"500人次以下/周"},{text:"501-2500人次/周"},{text:"2501-5000人次/周"},{text:"5001-10000人次/周"},{text:"10000人次以上/周"}];return dataSet},getOperModeTreeData:function(){var dataSet=[{text:"自主运营"},{text:"合作运营"},{text:"委托运营"}];return dataSet},getNavBtnConfig:function(){var tbName=arguments[0],fileName=arguments[1]||"体育场馆信息表.xlsx";return{caption:"导出excel",buttonicon:"ui-icon-disk",onClickButton:function(){if(tbName){}},position:"last",}},getStadiumJqConf_Old:function(tbName,pager){var config={};config.jqGridConfig={colNames:["所属街道","组织机构代码","场地代码","场地名称","场地分布","场地归属","建成年份","用地面积（㎡）","建筑面积（㎡）","场地面积（㎡）","投资金额（合计）","财政拨款","体彩公益金","单位自筹","社会捐赠","其他"],colModel:[{name:"所属街道",index:"所属街道",width:60,sorttype:"text"},{name:"组织机构代码",index:"组织机构代码",width:60,sorttype:"text"},{name:"场地代码",index:"场地代码",width:80,sorttype:"text"},{name:"场地名称",index:"场地名称",width:120,sorttype:"text"},{name:"场地分布",index:"场地分布",width:80},{name:"场地归属",index:"场地归属",width:80},{name:"建成年份",index:"建成年份",width:60,sorttype:"int"},{name:"用地面积（㎡）",index:"用地面积（㎡）",width:80,sorttype:"float",summaryType:"sum",summaryTpl:"∑:{0}"},{name:"建筑面积（㎡）",index:"建筑面积（㎡）",width:80,sorttype:"float",summaryType:"sum",summaryTpl:"∑:{0}"},{name:"场地面积（㎡）",index:"场地面积（㎡）",width:80,sorttype:"float",summaryType:"sum",summaryTpl:"∑:{0}"},{name:"投资金额（合计）",index:"投资金额（合计）",width:80,sorttype:"float",summaryType:"sum",summaryTpl:"∑:{0}"},{name:"财政拨款",index:"财政拨款",width:80,sorttype:"float",summaryType:"sum",summaryTpl:"∑:{0}"},{name:"体彩公益金",index:"体彩公益金",width:80,sorttype:"float",summaryType:"sum",summaryTpl:"∑:{0}"},{name:"单位自筹",index:"单位自筹",width:80,sorttype:"float",summaryType:"sum",summaryTpl:"∑:{0}"},{name:"社会捐赠",index:"社会捐赠",width:80,sorttype:"float",summaryType:"sum",summaryTpl:"∑:{0}"},{name:"其他",index:"其他",width:80,sorttype:"float",summaryType:"sum",summaryTpl:"∑:{0}"}],pager:pager,sortname:"场地名称",caption:"场地信息",grouping:true,groupingView:{groupField:["所属街道","场地代码"],groupColumnShow:[true,true],groupText:["<b>{0}<b> 总计: {1}","{0} 小计: {1}"],groupCollapse:true,groupSummary:[false,true]},};
var navConfigs=[];config.navConfig=navConfigs;navConfigs.push(dataManager.getNavBtnConfig(tbName,"场馆信息.xlsx"));navConfigs.push(dataManager.getExpandBtnConfig());navConfigs.push(dataManager.getColaspeBtnConfig());return config},getStadiumJqConf:function(tbName,pager,colConf){var config={};config.jqGridConfig={colNames:colConf.colNames,colModel:colConf.colModel,pager:pager,sortname:"场地名称",caption:"场地信息",grouping:true,groupingView:{groupColumnShow:[true,true],groupText:["<b>{0}<b> 总计: {1}","{0} 小计: {1}"],groupCollapse:true,groupSummary:[false,true]},};var navConfigs=[];config.navConfig=navConfigs;navConfigs.push(dataManager.getNavBtnConfig(tbName,"场馆信息.xlsx"));navConfigs.push(dataManager.getExpandBtnConfig());navConfigs.push(dataManager.getColaspeBtnConfig());return config},getEcoStatusConf:function(tbName,pager){var config={};config.jqGridConfig={colNames:["年份","场地名称","场地从业人员人数","运营模式","对外开放情况","年开放天数","平均每周接待健身人次","收入合计（千元）","支出合计（千元）"],colModel:[{name:"年份",index:"年份",width:60,sorttype:"text"},{name:"场地名称",index:"场地名称",width:120,sorttype:"text"},{name:"场地从业人员人数",index:"场地从业人员人数",width:80,sorttype:"int"},{name:"运营模式",index:"运营模式",width:80,sorttype:"text"},{name:"对外开放情况",index:"对外开放情况",width:80},{name:"年开放天数",index:"年开放天数",width:80,sorttype:"int"},{name:"平均每周接待健身人次",index:"平均每周接待健身人次",width:60},{name:"收入合计（千元）",index:"收入合计（千元）",width:80,sorttype:"float",summaryType:"sum",summaryTpl:"∑:{0}"},{name:"支出合计（千元）",index:"支出合计（千元）",width:80,sorttype:"float",summaryType:"sum",summaryTpl:"∑:{0}"},],pager:pager,sortname:"年份",caption:"运营情况",grouping:true,groupingView:{groupField:["年份","场地名称"],groupColumnShow:[true,true],groupText:["<b>{0}<b> 总计: {1}","{0} 小计: {1}"],groupCollapse:true,groupSummary:[false,true]},};var navConfigs=[];navConfigs.push(dataManager.getNavBtnConfig(tbName,"运营情况.xlsx"));navConfigs.push(dataManager.getExpandBtnConfig());navConfigs.push(dataManager.getColaspeBtnConfig());config.navConfig=navConfigs;return config},getEcoStautsJqConf:function(tbName,pager,colConf){var config={};
config.jqGridConfig={colNames:colConf.colNames,colModel:colConf.colModel,pager:pager,sortname:"场地名称",caption:"运营情况",grouping:true,groupingView:{groupColumnShow:[true,true],groupText:["<b>{0}<b> 总计: {1}","{0} 小计: {1}"],groupCollapse:true,groupSummary:[false,true]},};var navConfigs=[];config.navConfig=navConfigs;navConfigs.push(dataManager.getNavBtnConfig(tbName,"运营情况.xlsx"));navConfigs.push(dataManager.getExpandBtnConfig());navConfigs.push(dataManager.getColaspeBtnConfig());return config},getExpandBtnConfig:function(){return{caption:"展开",buttonicon:"ui-icon-zoomin",onClickButton:function(){$("#"+this.id+" .ui-icon-circlesmall-plus").trigger("click")},position:"last",}},getColaspeBtnConfig:function(){return{caption:"折叠",buttonicon:"ui-icon-zoomout",onClickButton:function(){$("#"+this.id+" .ui-icon-circlesmall-minus").trigger("click")},position:"last",}},};window.notifier=(function(){var notifObj={};var to,width,height,position,autohide,opacity;function notifitSetDefaultValues(){width=400;height=60;position="right";autohide=true;msg="";opacity=1}function notifitDismiss(){clearInterval(to);if(position=="center"){$("#ui_notifIt").animate({top:parseInt(height-(height/2))},100,function(){$("#ui_notifIt").animate({top:parseInt(0-(height*2))},100,function(){$("#ui_notifIt").remove()})})}else{if(position=="right"){$("#ui_notifIt").animate({right:parseFloat(width-(width*0.9))},100,function(){$("#ui_notifIt").animate({right:parseInt(0-(width*2))},100,function(){$("#ui_notifIt").remove()})})}else{if(position=="left"){$("#ui_notifIt").animate({left:parseFloat(width-(width*0.9))},100,function(){$("#ui_notifIt").animate({left:parseInt(0-(width*2))},100,function(){$("#ui_notifIt").remove()})})}}}notifitSetDefaultValues()}notifObj.showNotice=function notif(config){notifitSetDefaultValues();if(config.position){if(config.position=="center"||config.position=="left"||config.position=="right"){position=config.position}}if(config.width){if(config.width>0){width=config.width}else{if(config.width==="all"){width=screen.width-60
}}}if(config.height){if(config.height<100&&config.height>0){height=config.height}}if(typeof config.autohide!=="undefined"){autohide=config.autohide}var div="<div id='ui_notifIt'><p>"+((config.msg)?config.msg:"")+"</p></div>";$("#ui_notifIt").remove();clearInterval(to);$("body").append(div);$("#ui_notifIt").css("height",height);$("#ui_notifIt").css("width",width);switch(position){case"center":$("#ui_notifIt").css("top",parseInt(0-(height+10)));break;case"right":$("#ui_notifIt").css("right",parseInt(0-(width+10)));break;case"left":$("#ui_notifIt").css("left",parseInt(0-(width+10)));break;default:$("#ui_notifIt").css("right",parseInt(0-(width+10)));break}if(config.opacity){$("#ui_notifIt").css("opacity",config.opacity)}switch(config.type){case"error":$("#ui_notifIt").addClass("error");break;case"success":$("#ui_notifIt").addClass("success");break;case"info":$("#ui_notifIt").addClass("info");break;case"warning":$("#ui_notifIt").addClass("warning");break;default:$("#ui_notifIt").addClass("default");break}switch(position){case"left":$("#ui_notifIt").css("left",parseInt(0-(width*2)));break;case"right":$("#ui_notifIt").css("right",parseInt(0-(width*2)));break;case"center":var mid=window.innerWidth/2;$("#ui_notifIt").css("left",mid-parseInt(width/2));break;default:var mid=window.innerWidth/2;$("#ui_notifIt").css("left",mid-parseInt(width/2));break}$("#ui_notifIt p").css("line-height",height+"px");switch(position){case"center":$("#ui_notifIt").animate({top:10});break;case"right":$("#ui_notifIt").animate({right:10});break;case"left":$("#ui_notifIt").animate({left:10});break;default:$("#ui_notifIt").animate({right:10});break}$("#ui_notifIt").click(function(){notifitDismiss()});if(autohide==true){to=setTimeout(function(){notifitDismiss()},3000)}};return notifObj})();var lsDataOrger=(function(){var resvDic={};var dataOrger={};var resvDict={"Name":"场地名称","Category":"场地代码","Owner":"场地归属","StadiumBase":"基本信息","OrgCode":"组织机构代码","Place":"场地分布","FoundYear":"建成年份","LandArea":"用地面积（㎡）","BuildingArea":"建筑面积（㎡）","SiteArea":"场地面积（㎡）","Investment":"投资金额（合计）","Fiscal":"财政拨款","CommonWeal":"体彩公益金","SelfRaised":"单位自筹","SocialDonate":"社会捐赠","Other":"其他","Year":"年份","Employee":"场地从业人员人数","OperateMode":"运营模式","OpenStatus":"对外开放情况","OpeningDays":"年开放天数","ClientCount":"平均每周接待健身人次","Income":"收入合计（千元）","Expend":"支出合计（千元）","StatdiumName":"场地名称","StreetId":"所属街道",};
function iterateAry(ary,temp){if(ary&&ary.length>0){for(var index in ary){if(temp["场地归属"]){temp["场地归属"]=temp["场地归属"]+","+ary[index]["Owner"].Name}else{temp["场地归属"]=ary[index]["Owner"].Name}}}else{temp["场地归属"]=""}}function iterateProp(item,parentTemp){var temp=parentTemp||{};for(var prop in item){if(resvDic[prop]&&resvDic.hasOwnProperty(prop)){if(prop==="StadiumBase"){iterateProp(item[prop],temp);continue}if(prop==="EcoStatus"){continue}if(prop==="StreetId"){temp[resvDic[prop]]=streetDict[item[prop]];continue}switch(typeof(item[prop])){case"object":if(item[prop]){temp[resvDic[prop]]=item[prop]["Name"]||item[prop]}else{temp[resvDic[prop]]=""}break;case"boolean":temp[resvDic[prop]]=item[prop]?"是":"否";break;case"undefined":temp[resvDic[prop]]="";break;default:temp[resvDic[prop]]=item[prop]}}}return temp}dataOrger.setData=function(data,intrinsicDict){var orgedData=[];resvDic=intrinsicDict||resvDict;util.eachProp(data,function(item){orgedData.push(iterateProp(item))});return orgedData};return dataOrger})();var jqGridMgr=(function(){var defaultConfig={autowidth:true,datatype:"local",height:"auto",rowNum:100,rowList:[50,100,200,400],viewrecords:true,shrinkToFit:true,rownumbers:true,};function mergeProps(formerconfig,colConfigs){for(var prop in colConfigs){if(colConfigs.hasOwnProperty(prop)){if(formerconfig.hasOwnProperty[prop]){continue}formerconfig[prop]=colConfigs[prop]}}}var jqgridMgr={};jqgridMgr.setJqGrid=function(jqGridId,colConfigs){var config=arguments[2]||defaultConfig;mergeProps(config,colConfigs);$(jqGridId).jqGrid(config)};jqgridMgr.setJqGridWithNavBtn=function(jqGridId,pagerId,jqConfig){this.setJqGrid(jqGridId,jqConfig.jqGridConfig);$(jqGridId).jqGrid("navGrid",pagerId,{edit:false,add:false,del:false,search:false,refresh:false}).jqGrid("navButtonAdd",pagerId,jqConfig.navConfig)};jqgridMgr.setJqGridWithCustomBtns=function(jqGridId,pagerId,jqConfig){this.setJqGrid(jqGridId,jqConfig.jqGridConfig);util.eachProp(jqConfig.navConfig,function(config){$(jqGridId).jqGrid("navGrid",pagerId,{edit:false,add:false,del:false,search:false,refresh:false}).jqGrid("navButtonAdd",pagerId,config)
})};jqgridMgr.setData=function(jqGridId,gridData){var theJqGrid=$(jqGridId);theJqGrid.clearGridData();theJqGrid.jqGrid("setGridParam",{data:gridData,localReader:{repeatitems:true,cell:"",id:0}}).trigger("reloadGrid")};return jqgridMgr})();var baiduMap=(function(){var bMap;var baiduapi={};baiduapi.markerClusterer;function initialPanorama(map){var stCtrl=new window.BMap.PanoramaControl();stCtrl.setOffset(new window.BMap.Size(20,45));map.addControl(stCtrl)}function showTraffic(){var trafficCtrl=new window.BMapLib.TrafficControl({showPanel:false});bMap.addControl(trafficCtrl);trafficCtrl.setAnchor(BMAP_ANCHOR_BOTTOM_RIGHT)}function addContextMenu(){try{var menu=new window.BMap.ContextMenu();var txtMenuItem=[{text:"回到初始位置",callback:function(){bMap.centerAndZoom("武汉 洪山区",12)}},{text:"地图测距",callback:function(){var disTool=new window.BMapLib.DistanceTool(bMap);disTool.open()}}];for(var i=0,len=txtMenuItem.length;i<len;i++){menu.addItem(new window.BMap.MenuItem(txtMenuItem[i].text,txtMenuItem[i].callback,100))}bMap.addContextMenu(menu)}catch(e){console.log(e.message)}}baiduapi.initialMapCtrls=function(){baiduapi.bmap=new window.BMap.Map("mapID");bMap=baiduapi.bmap;bMap.centerAndZoom("武汉 洪山区",12);bMap.addControl(new window.BMap.NavigationControl());bMap.addControl(new window.BMap.ScaleControl());bMap.addControl(new window.BMap.OverviewMapControl());bMap.enableScrollWheelZoom();bMap.addControl(new window.BMap.MapTypeControl());initialPanorama(bMap);showTraffic();addContextMenu()};function getInfoWindowPara(stadiumItem){var para={};para.title=stadiumItem.Name;para.width=300;para.height=180;para.panel="panel";para.enableAutoPan=true;para.searchTypes=[];para.enableSendToPhone=false;return para}function getContent(stadiumItem){var orgCode=stadiumItem.OrgCode||"未填报";var place=stadiumItem.Place||"未填报";var foundYear=stadiumItem.FoundYear||"未填报";var cate=stadiumItem.Category||"未填报";var street=stadiumItem.Street||"未填报";var noteInfo=stadiumItem.Note||"未填报";var stadiumId=stadiumItem.SiteId;
var content;if(stadiumItem.Photo){var imageSrc="data:image/svg;base64,"+stadiumItem.Photo;var imageStr='"'+imageSrc.toString()+'"';content='<div style="margin:0;line-height:20px;padding:2px;">'+"<img src="+imageStr+'alt="" style="float:right;zoom:1;overflow:hidden;width:100px;height:100px;margin-left:3px;"/>'+"<b>场地代码   ：</b>"+cate+"<br/>"+"<b>组织机构代码：</b>"+orgCode+"<br/>"+"<b>场地分布   ：</b>"+place+"<br/>"+"<b>建成年份   ：</b>"+foundYear+"<br/>"+"<b>所属街道   ：</b>"+street+"<br/>"+"<b>相册       :</b>"+"<a data-para = "+stadiumId+" href = '#' onclick = \"window.albumMgr.init(this);\">点击查看场地图片</a>"+"<br/>"+"<b>备注信息   ：</b>"+noteInfo+"<br/>"+"</div>"}else{content='<div style="margin:0;line-height:20px;padding:2px;">'+"<b>场地代码   ：</b>"+cate+"<br/>"+"<b>组织机构代码：</b>"+orgCode+"<br/>"+"<b>场地分布   ：</b>"+place+"<br/>"+"<b>建成年份   ：</b>"+foundYear+"<br/>"+"<b>所属街道   ：</b>"+street+"<br/>"+"<b>相册       :</b>"+"<a data-para = "+stadiumId+" href = '#' onclick = \"window.albumMgr.init(this);\">点击查看场地图片</a>"+"<br/>"+"<b>备注信息   ：</b>"+noteInfo+"<br/>"+"</div>"}return content}function showInfoWindow(stadiumItem,pMarker){var winPara=getInfoWindowPara(stadiumItem);var content=getContent(stadiumItem);var searchInfoWindow=new window.BMapLib.SearchInfoWindow(bMap,content,winPara);searchInfoWindow.open(pMarker)}baiduapi.addPin2Map=function(stadiumItem){try{var x=stadiumItem.Longitude,y=stadiumItem.Latitude;var siteName=stadiumItem.Name;if(bMap){var marker;var stadiumName=stadiumItem.Name;if(x&&y){var point=new window.BMap.Point(x,y);marker=new window.BMap.Marker(point,{title:stadiumName});marker.addEventListener("click",function(){showInfoWindow(stadiumItem,marker)})}else{if(siteName){var myGeo=new window.BMap.Geocoder();myGeo.getPoint(siteName,function(pt){if(pt){marker=new window.BMap.Marker(pt,{title:stadiumName});marker.addEventListener("click",function(){showInfoWindow(stadiumItem,marker)})}},"武汉市 洪山区")}}return marker}}catch(e){console.log(e.message)}};return baiduapi})();var queryManager=(function(){var queryMgr={};
var panel2Tree={"#streetPanel":"#streetTree","#catePanel":"#cateTree","#placePanel":"#placeTree","#ownerPanel":"#ownerTree","#openingPanel":"#openingTree","#recievePanel":"#recieveTree","#operModePanel":"#operModeTree"};var treeNodeType={"#streetTree":"id","#cateTree":"id","#placeTree":"text","#ownerTree":"text","#openingTree":"text","#recieveTree":"text","#operModeTree":"text"};var screenPara={"#streetTree":"streetPara","#cateTree":"catePara","#placeTree":"placePara","#ownerTree":"ownerPara","#openingTree":"openPara","#recieveTree":"recievePara","#operModeTree":"operModePara"};function addPin2Map(promiseItems){if(baiduMap.bmap){var markers=[];util.eachProp(promiseItems,function(pStadium){var marker=baiduMap.addPin2Map(pStadium);markers.push(marker)});if(baiduMap.markerClusterer){baiduMap.markerClusterer.clearMarkers();baiduMap.markerClusterer.addMarkers(markers)}else{baiduMap.markerClusterer=new window.BMapLib.MarkerClusterer(baiduMap.bmap,{markers:markers});baiduMap.markerClusterer.isAverangeCenter=true}}}function loadStadiumInfoGrid(stadiumItems){var stadiumData=lsDataOrger.setData(stadiumItems);jqGridMgr.setData("#stadiumInfo",stadiumData);util.upDatePivot("#stadiumPivot",stadiumData)}queryMgr.doQuery=function(screen,panelId){try{window.timeStart=new Date();if(panelId){var treeId=panel2Tree[panelId];if(treeId){var ids=util.getCheckedTreeNode(treeId,treeNodeType[treeId]);var para=screenPara[treeId];screen[para]=ids;util.eachProp(screenPara,function(val){if(val!==para){screen[val]=undefined}})}}else{var streetIds=util.getCheckedTreeNode("#streetTree","id");var cateIds=util.getCheckedTreeNode("#cateTree","id");var placeStrs=util.getCheckedTreeNode("#placeTree","text");var ownerIds=util.getCheckedTreeNode("#ownerTree","text");var openIds=util.getCheckedTreeNode("#openingTree","text");var recvIds=util.getCheckedTreeNode("#recieveTree","text");var operIds=util.getCheckedTreeNode("#operModeTree","text");screen.streetPara=streetIds;screen.catePara=cateIds;screen.placePara=placeStrs;
screen.ownerPara=ownerIds;screen.openPara=openIds;screen.recievePara=recvIds;screen.operModePara=operIds}screen.CombindedStadiumQuery.load().then(function(){var combinedStadiums=screen.CombindedStadiumQuery.data;addPin2Map(combinedStadiums);loadStadiumInfoGrid(combinedStadiums);screen.RiaEcostatusQuery.load().then(function(){var combinedEco=screen.RiaEcostatusQuery.data;var ecoStatusData=lsDataOrger.setData(combinedEco);jqGridMgr.setData("#ecoStatusInfo",ecoStatusData);util.upDatePivot("#ecoPivot",ecoStatusData);var timeNow=new Date();var timeSpan=timeNow-window.timeStart;var timeSec=Math.floor(timeSpan/1000);notifier.showNotice({msg:"<b>查询完毕！耗时约:</b>"+timeSec+"<b>秒</b>",type:"success",position:"center",opacity:0.9})})})}catch(e){console.log(e.message)}};function o2SGroupByStadium(o2sItems){try{var grouped={};var unGroupedItems=o2sItems;util.eachProp(unGroupedItems,function(o2sItem){var stadiumId=o2sItem.Stadium.Id;if(grouped[stadiumId]){grouped[stadiumId].Owner=grouped[stadiumId].Owner+","+o2sItem.Owner.Name}else{grouped[stadiumId]=o2sItem.Stadium;grouped[stadiumId].Owner=o2sItem.Owner.Name}});return grouped}catch(e){console.log(e.message)}}function getSelectedIDs(promiseDatas){var ids;for(var i=0;i<promiseDatas.count;i++){if(!ids){ids=promiseDatas.data[i].Id}else{ids+=","+promiseDatas.data[i].Id}}if(promiseDatas.count==1){ids+=","+""}return ids}return queryMgr})();var uiManager=(function(){var contentItem,element,screen;function UiManager(config){try{contentItem=config.contentItem;screen=contentItem.screen;element=config.element}catch(e){console.log(e.message)}}function addPanelSearch(panelId){$(panelId).panel({tools:[{iconCls:"icon-search",handler:function(){queryManager.doQuery(screen,panelId)}}]})}function initJqGrid(){var stadiumConf=dataManager.getStadiumJqConf("#stadiumInfo","#stadiumPager");jqGridMgr.setJqGridWithCustomBtns("#stadiumInfo","#stadiumPager",stadiumConf);var ecoStatusConf=dataManager.getEcoStatusConf("#ecoStatusInfo","#ecoStatusPager");jqGridMgr.setJqGridWithCustomBtns("#ecoStatusInfo","#ecoStatusPager",ecoStatusConf);
util.resizJqGrid()}function initJqGridTest(permissions){myapp.activeDataWorkspace.ApplicationData.JqgridColConfQuery(permissions).execute().then(function(colConfigs){var propDict={"Name":"name","Index":"index","Width":"width","Sorttype":"sorttype","SummaryTpl":"summaryTpl","SummaryType":"summaryType","JqGrid":"JqGrid"};var colConf=lsDataOrger.setData(colConfigs.results,propDict);var colNamesStadium=[];var colNamesEconomy=[];var colConfStatdium=$.grep(colConf,function(e){return e.JqGrid==="Stadium"});var colConfEconomy=$.grep(colConf,function(e){return e.JqGrid==="Ecostatus"});util.eachAry(colConf,function(aryItem){if(aryItem.JqGrid==="Ecostatus"){colNamesEconomy.push(aryItem.name)}else{colNamesStadium.push(aryItem.name)}});var stadiumConf=dataManager.getStadiumJqConf("#stadiumInfo","#stadiumPager",{colNames:colNamesStadium,colModel:colConfStatdium});jqGridMgr.setJqGridWithCustomBtns("#stadiumInfo","#stadiumPager",stadiumConf);var ecoStatusConf=dataManager.getEcoStautsJqConf("#ecoStatusInfo","#ecoStatusPager",{colNames:colNamesEconomy,colModel:colConfEconomy});jqGridMgr.setJqGridWithCustomBtns("#ecoStatusInfo","#ecoStatusPager",ecoStatusConf);util.resizJqGrid();var groupByStock=$("#groupBySelector");var ecoGroupByer=$("#EcoGroupByer");var grouperStadium=JqGridGrouper.createNew({"pNode":groupByStock,"groupCols":colNamesStadium,"jqGridId":"#stadiumInfo"});grouperStadium.init();var grouperEco=JqGridGrouper.createNew({"pNode":ecoGroupByer,"groupCols":colNamesEconomy,"jqGridId":"#ecoStatusInfo"});grouperEco.init()})}function initPivot(pivotId){try{window.__pivotHash__[pivotId]=$(pivotId).pivotUI([],{renderers:$.pivotUtilities.locales.zh.renderers},true,"zh");$(window).bind("resize",function(){$(pivotId).width(($("#regioncenter").width()*0.9))})}catch(e){console.log(e)}}function bindComboEvent(){var getGpFields=function(tbName){var gpField=$(tbName).jqGrid("getGridParam","groupingView");return gpField.groupField};var getGroupIdentify=function(gpField){var queue=function(arr,size){if(size>arr.length){return null
}var allResult=[];(function(arr,size,result){if(result.length==size){allResult.push(result)}else{for(var i=0,len=arr.length;i<len;i++){var newArr=[].concat(arr),curItem=newArr.splice(i,1);arguments.callee(newArr,size,[].concat(result,curItem))}}})(arr,size,[]);return allResult};return queue(gpField,gpField.length)};var getGroupDic=function(comboData){var obj={};var disArr=[];var hash=[];var id=0;comboData.forEach(function(subArr){var disStr;subArr.forEach(function(str){if(!disStr){disStr=str}else{disStr+="-"+str}});var option={};option.id=id++;option.text=disStr;disArr.push(option);hash[disStr]=subArr});disArr.push({id:id++,text:"无"});obj.disArr=disArr;obj.hash=hash;return obj};var applyGroup=function(comboName,tbName,gpField){var select=$(comboName).combobox("getText");if(select=="无"){disableGroup(tbName)}else{$(tbName).setGridParam({groupingView:{groupField:gpField[select]},grouping:true}).trigger("reloadGrid")}};var disableGroup=function(tbName){$(tbName).setGridParam({grouping:false}).trigger("reloadGrid")};var comboOnSelect=function(tbName,combo){var combData=getGroupIdentify(getGpFields(tbName));var combObj=getGroupDic(combData);$(combo).combobox({data:combObj.disArr});$(combo).combobox({onSelect:function(){applyGroup(combo,tbName,combObj.hash)}})};comboOnSelect("#ecoStatusInfo","#ecoCombo");comboOnSelect("#stadiumInfo","#stadiumCombo")}UiManager.prototype={initialEasyUi:function(){var userPermissions=util.getPermissionAry(arguments[0]);$(element).append(uiBuilder.buildLayout(userPermissions));$("#layout").layout();$(".easyui-tabs").tabs();$(".easyui-linkbutton").linkbutton();$("#accordionID").accordion();dataManager.loadTree("#streetTree","StreetSet");dataManager.loadTree("#ownerTree","OwnerSet");dataManager.loadStaticTree("#placeTree",dataManager.getPlaceTreeData());dataManager.loadStaticTree("#openingTree",dataManager.getOpenTreeData());dataManager.loadStaticTree("#recieveTree",dataManager.getRecvTreeData());dataManager.loadStaticTree("#operModeTree",dataManager.getOperModeTreeData());
dataManager.loadCateTree("#cateTree");$("#lbSeachID").bind("click",function(e){queryManager.doQuery(screen)});$("#expandID").bind("click",function(e){$("#cateTree").tree("expandAll")});$("#collapseID").bind("click",function(e){$("#cateTree").tree("collapseAll")});addPanelSearch("#streetPanel");addPanelSearch("#catePanel");addPanelSearch("#placePanel");addPanelSearch("#ownerPanel");addPanelSearch("#openingPanel");addPanelSearch("#recievePanel");addPanelSearch("#operModePanel");initJqGridTest(arguments[0]);$(window).resize(function(){util.resizeLayout()});util.onRegionCentrChange();util.resizeLayout();baiduMap.initialMapCtrls()},};return UiManager})();var mainManager=(function(){var easyUiManager;function MainManager(element,contentItem){this._element=element;this._contentItem=contentItem;easyUiManager=new uiManager({contentItem:contentItem,element:element})}MainManager.prototype={run:function(){try{easyUiManager.initialEasyUi(arguments[0])}catch(e){console.log(e.message)}}};return MainManager})();var managerFactory={create:function(element,contentItem){return new mainManager(element,contentItem)}};return managerFactory});
var BMapLib=window.BMapLib=BMapLib||{};(function(){var getExtendedBounds=function(map,bounds,gridSize){bounds=cutBoundsInRange(bounds);var pixelNE=map.pointToPixel(bounds.getNorthEast());var pixelSW=map.pointToPixel(bounds.getSouthWest());pixelNE.x+=gridSize;pixelNE.y-=gridSize;pixelSW.x-=gridSize;pixelSW.y+=gridSize;var newNE=map.pixelToPoint(pixelNE);var newSW=map.pixelToPoint(pixelSW);return new BMap.Bounds(newSW,newNE)};var cutBoundsInRange=function(bounds){var maxX=getRange(bounds.getNorthEast().lng,-180,180);var minX=getRange(bounds.getSouthWest().lng,-180,180);var maxY=getRange(bounds.getNorthEast().lat,-74,74);var minY=getRange(bounds.getSouthWest().lat,-74,74);return new BMap.Bounds(new BMap.Point(minX,minY),new BMap.Point(maxX,maxY))};var getRange=function(i,mix,max){mix&&(i=Math.max(i,mix));max&&(i=Math.min(i,max));return i};var isArray=function(source){return"[object Array]"===Object.prototype.toString.call(source)};var indexOf=function(item,source){var index=-1;if(isArray(source)){if(source.indexOf){index=source.indexOf(item)}else{for(var i=0,m;m=source[i];i++){if(m===item){index=i;break}}}}return index};var MarkerClusterer=BMapLib.MarkerClusterer=function(map,options){if(!map){return}this._map=map;this._markers=[];this._clusters=[];var opts=options||{};this._gridSize=opts["gridSize"]||60;this._maxZoom=opts["maxZoom"]||18;this._minClusterSize=opts["minClusterSize"]||2;this._isAverageCenter=false;if(opts["isAverageCenter"]!=undefined){this._isAverageCenter=opts["isAverageCenter"]}this._styles=opts["styles"]||[];var that=this;this._map.addEventListener("zoomend",function(){that._redraw()});this._map.addEventListener("moveend",function(){that._redraw()});var mkrs=opts["markers"];isArray(mkrs)&&this.addMarkers(mkrs)};MarkerClusterer.prototype.addMarkers=function(markers){for(var i=0,len=markers.length;i<len;i++){this._pushMarkerTo(markers[i])}this._createClusters()};MarkerClusterer.prototype._pushMarkerTo=function(marker){var index=indexOf(marker,this._markers);
if(index===-1){marker.isInCluster=false;this._markers.push(marker)}};MarkerClusterer.prototype.addMarker=function(marker){this._pushMarkerTo(marker);this._createClusters()};MarkerClusterer.prototype._createClusters=function(){var mapBounds=this._map.getBounds();var extendedBounds=getExtendedBounds(this._map,mapBounds,this._gridSize);for(var i=0,marker;marker=this._markers[i];i++){if(!marker.isInCluster&&extendedBounds.containsPoint(marker.getPosition())){this._addToClosestCluster(marker)}}this._updateClusters()};MarkerClusterer.prototype._updateClusters=function(){for(var i=0,cluster;cluster=this._clusters[i];i++){cluster.updateClusterMarker()}};MarkerClusterer.prototype._addToClosestCluster=function(marker){var distance=4000000;var clusterToAddTo=null;for(var i=0,cluster;cluster=this._clusters[i];i++){var center=cluster.getCenter();if(center){var d=this._map.getDistance(center,marker.getPosition());if(d<distance){distance=d;clusterToAddTo=cluster}}}if(clusterToAddTo&&clusterToAddTo.isMarkerInClusterBounds(marker)){clusterToAddTo.addMarker(marker)}else{var cluster=new Cluster(this);cluster.addMarker(marker);this._clusters.push(cluster)}};MarkerClusterer.prototype._clearLastClusters=function(){for(var i=0,cluster;cluster=this._clusters[i];i++){cluster.remove()}this._clusters=[];this._removeMarkersFromCluster()};MarkerClusterer.prototype._removeMarkersFromCluster=function(){for(var i=0,marker;marker=this._markers[i];i++){marker.isInCluster=false}};MarkerClusterer.prototype._removeMarkersFromMap=function(){for(var i=0,marker;marker=this._markers[i];i++){marker.isInCluster=false;this._map.removeOverlay(marker)}};MarkerClusterer.prototype._removeMarker=function(marker){var index=indexOf(marker,this._markers);if(index===-1){return false}this._map.removeOverlay(marker);this._markers.splice(index,1);return true};MarkerClusterer.prototype.removeMarker=function(marker){var success=this._removeMarker(marker);if(success){this._clearLastClusters();this._createClusters()}return success
};MarkerClusterer.prototype.removeMarkers=function(markers){var success=false;while(markers.length){var r=this._removeMarker(markers[0]);markers.splice(0,1);success=success||r}if(success){this._clearLastClusters();this._createClusters()}return success};MarkerClusterer.prototype.clearMarkers=function(){this._clearLastClusters();this._removeMarkersFromMap();this._markers=[]};MarkerClusterer.prototype._redraw=function(){this._clearLastClusters();this._createClusters()};MarkerClusterer.prototype.getGridSize=function(){return this._gridSize};MarkerClusterer.prototype.setGridSize=function(size){this._gridSize=size;this._redraw()};MarkerClusterer.prototype.getMaxZoom=function(){return this._maxZoom};MarkerClusterer.prototype.setMaxZoom=function(maxZoom){this._maxZoom=maxZoom;this._redraw()};MarkerClusterer.prototype.getStyles=function(){return this._styles};MarkerClusterer.prototype.setStyles=function(styles){this._styles=styles;this._redraw()};MarkerClusterer.prototype.getMinClusterSize=function(){return this._minClusterSize};MarkerClusterer.prototype.setMinClusterSize=function(size){this._minClusterSize=size;this._redraw()};MarkerClusterer.prototype.isAverageCenter=function(){return this._isAverageCenter};MarkerClusterer.prototype.getMap=function(){return this._map};MarkerClusterer.prototype.getMarkers=function(){return this._markers};MarkerClusterer.prototype.getClustersCount=function(){var count=0;for(var i=0,cluster;cluster=this._clusters[i];i++){cluster.isReal()&&count++}return count};function Cluster(markerClusterer){this._markerClusterer=markerClusterer;this._map=markerClusterer.getMap();this._minClusterSize=markerClusterer.getMinClusterSize();this._isAverageCenter=markerClusterer.isAverageCenter();this._center=null;this._markers=[];this._gridBounds=null;this._isReal=false;this._clusterMarker=new BMapLib.TextIconOverlay(this._center,this._markers.length,{"styles":this._markerClusterer.getStyles()})}Cluster.prototype.addMarker=function(marker){if(this.isMarkerInCluster(marker)){return false
}if(!this._center){this._center=marker.getPosition();this.updateGridBounds()}else{if(this._isAverageCenter){var l=this._markers.length+1;var lat=(this._center.lat*(l-1)+marker.getPosition().lat)/l;var lng=(this._center.lng*(l-1)+marker.getPosition().lng)/l;this._center=new BMap.Point(lng,lat);this.updateGridBounds()}}marker.isInCluster=true;this._markers.push(marker);var len=this._markers.length;if(len<this._minClusterSize){this._map.addOverlay(marker);return true}else{if(len===this._minClusterSize){for(var i=0;i<len;i++){this._markers[i].getMap()&&this._map.removeOverlay(this._markers[i])}}}this._map.addOverlay(this._clusterMarker);this._isReal=true;return true};Cluster.prototype.isMarkerInCluster=function(marker){if(this._markers.indexOf){return this._markers.indexOf(marker)!=-1}else{for(var i=0,m;m=this._markers[i];i++){if(m===marker){return true}}}return false};Cluster.prototype.isMarkerInClusterBounds=function(marker){return this._gridBounds.containsPoint(marker.getPosition())};Cluster.prototype.isReal=function(marker){return this._isReal};Cluster.prototype.updateGridBounds=function(){var bounds=new BMap.Bounds(this._center,this._center);this._gridBounds=getExtendedBounds(this._map,bounds,this._markerClusterer.getGridSize())};Cluster.prototype.updateClusterMarker=function(){if(this._map.getZoom()>this._markerClusterer.getMaxZoom()){this._clusterMarker&&this._map.removeOverlay(this._clusterMarker);for(var i=0,marker;marker=this._markers[i];i++){this._map.addOverlay(marker)}return}if(this._markers.length<this._minClusterSize){this._clusterMarker.hide();return}this._clusterMarker.setPosition(this._center);this._clusterMarker.setText(this._markers.length);var thatMap=this._map;var thatBounds=this.getBounds();this._clusterMarker.addEventListener("click",function(event){thatMap.setViewport(thatBounds)})};Cluster.prototype.remove=function(){for(var i=0,m;m=this._markers[i];i++){this._markers[i].getMap()&&this._map.removeOverlay(this._markers[i])}this._map.removeOverlay(this._clusterMarker);
this._markers.length=0;delete this._markers};Cluster.prototype.getBounds=function(){var bounds=new BMap.Bounds(this._center,this._center);for(var i=0,marker;marker=this._markers[i];i++){bounds.extend(marker.getPosition())}return bounds};Cluster.prototype.getCenter=function(){return this._center}})();
